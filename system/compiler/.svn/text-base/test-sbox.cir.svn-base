define(bits_to_array, `
//
// $1[0-15] := $2;
//
$1[ 0] := $2{  0,  7};
$1[ 1] := $2{  8, 15};
$1[ 2] := $2{ 16, 23};
$1[ 3] := $2{ 24, 31};
$1[ 4] := $2{ 32, 39};
$1[ 5] := $2{ 40, 47};
$1[ 6] := $2{ 48, 55};
$1[ 7] := $2{ 56, 63};
$1[ 8] := $2{ 64, 71};
$1[ 9] := $2{ 72, 79};
$1[10] := $2{ 80, 87};
$1[11] := $2{ 88, 95};
$1[12] := $2{ 96,103};
$1[13] := $2{104,111};
$1[14] := $2{112,119};
$1[15] := $2{120,127}')



define(sbox, `
//
// $1 := SBOX($2)
//
x := $2;
q := 0{4};

q{3} := (x{7} & (x{5} ^ x{4} ^ x{1} ^ x{0})) ^
        (x{6} & (x{5} ^ x{4} ^ x{2} ^ x{1})) ^
        (x{5} & (x{4} ^ x{2} ^ x{1} ^ x{0})) ^
        (x{4} & (x{2} ^ x{1})) ^
        (x{3} & (x{2} ^ x{1})) ^
        (x{2} & (x{1}));
q{2} := (x{7} & (x{6} ^ x{5} ^ x{3} ^ x{2} ^ x{0})) ^
        (x{6} & (x{5} ^ x{3} ^ x{2} ^ x{1} ^ x{0})) ^
        (x{5} & (x{3} ^ x{2})) ^
        (x{4} & (x{3} ^ x{2} ^ x{0})) ^
        (x{3} & (x{2} ^ x{0})) ^
        ((x{2} ^ x{1}) & x{0});
q{1} := (x{7} & (x{5} ^ x{2} ^ x{0} ^ 1{1})) ^
        (x{6} & (x{5} ^ x{3})) ^
        (x{5} & (x{4} ^ x{3} ^ x{2} ^ x{0} ^ 1{1})) ^
        (x{4} & (x{2} ^ 1{1})) ^
        (x{3} & (x{2} ^ x{0})) ^
        (x{2} & (x{1} ^ x{0} ^ 1{1})) ^
        (x{1});
q{0} := (x{7} & (x{6} ^ x{4} ^ x{0})) ^
        (x{6} & (x{5} ^ x{4} ^ x{3} ^ x{1} ^ 1{1})) ^
        (x{5} & (x{3} ^ x{0} ^ 1{1})) ^
        (x{4} & (x{3} ^ x{1})) ^
        (x{3} & (x{2} ^ x{1} ^ x{0} ^ 1{1})) ^
        ((x{2} ^ x{1}) & x{0}) ^
        (x{0} ^ x{2});

y := 0{4};

// y := 1/q
y{3} := q{3} ^ (q{3}&q{2}&q{1}) ^ (q{3}&q{0}) ^ q{2};
y{2} := (q{3}&q{2}&q{1}) ^ (q{3}&q{2}&q{0}) ^ (q{3}&q{0}) ^ 
        q{2} ^ (q{2}&q{1});
y{1} := q{3} ^ (q{3}&q{2}&q{1}) ^ (q{3}&q{1}&q{0}) ^ q{2} ^ 
        (q{2}&q{0}) ^ q{1};
y{0} := (q{3}&q{2}&q{1}) ^ (q{3}&q{2}&q{0}) ^ (q{3}&q{1}) ^ 
        (q{3}&q{1}&q{0}) ^ (q{3}&q{0}) ^ q{2} ^ (q{2}&q{1}) ^ 
        (q{2}&q{1}&q{0}) ^ q{1} ^ q{0};

t := 0{8};

t{7} := (y{3} & (x{7} ^ x{6} ^ x{4} ^ x{0})) ^
        (y{2} & (x{5} ^ x{4} ^ x{3} ^ x{0})) ^
        (y{1} & (x{5} ^ x{4} ^ x{3} ^ x{2} ^ x{1})) ^
        (y{0} & (x{7} ^ x{2} ^ x{1}));
t{6} := (y{3} & (x{7} ^ x{6} ^ x{4})) ^
        (y{2} & (x{7} ^ x{5} ^ x{1})) ^
        (y{1} & (x{6} ^ x{5} ^ x{4})) ^
        (y{0} & (x{6} ^ x{5} ^ x{4} ^ x{3} ^ x{2}));	   
t{5} := (y{3} & (x{7} ^ x{6} ^ x{5} ^ x{2})) ^
        (y{2} & (x{7} ^ x{5} ^ x{0})) ^
        (y{1} & (x{4} ^ x{3})) ^
        (y{0} & (x{7} ^ x{6} ^ x{5}));	   
t{4} := (y{3} & (x{6} ^ x{5} ^ x{2})) ^
        (y{2} & (x{7} ^ x{6} ^ x{5} ^ x{3} ^ x{2})) ^
        (y{1} & (x{5} ^ x{4} ^ x{3} ^ x{2} ^ x{1} ^ x{0})) ^
        (y{0} & (x{4} ^ x{3} ^ x{2} ^ x{0}));
t{3} := (y{3} & (x{7} ^ x{6} ^ x{5} ^ x{4} ^ x{3} ^ x{2} ^ x{1})) ^
        (y{2} & (x{7} ^ x{6} ^ x{5} ^ x{3} ^ x{2} ^ x{0})) ^
        (y{1} & (x{7} ^ x{3} ^ x{1} ^ x{0})) ^
        (y{0} & (x{6} ^ x{4} ^ x{1} ^ x{0}));
t{2} := (y{3} & (x{5} ^ x{2} ^ x{1} ^ x{0})) ^
        (y{2} & (x{7} ^ x{6} ^ x{5} ^ x{4} ^ x{3} ^ x{2} ^ x{0})) ^
        (y{1} & (x{7} ^ x{5} ^ x{4})) ^
        (y{0} & (x{4} ^ x{2} ^ x{1} ^ x{0}));
t{1} := (y{3} & (x{6} ^ x{4} ^ x{3} ^ x{1})) ^
        (y{2} & (x{6} ^ x{5} ^ x{3} ^ x{1})) ^
        (y{1} & (x{7})) ^
        (y{0} & (x{6} ^ x{3} ^ x{2} ^ x{0}));
t{0} := (y{3} & (x{7} ^ x{3} ^ x{2} ^ x{1})) ^
        (y{2} & (x{7} ^ x{4} ^ x{0})) ^
        (y{1} & (x{6} ^ x{4} ^ x{2} ^ x{0})) ^
        (y{0} & (x{5} ^ x{3} ^ x{2} ^ x{0}));

t := t ^ 99{8};
$1 := t')

define(sbox2, `
x := $2;
x := x{0}.x{1}.x{2}.x{3}.x{4}.x{5}.x{6}.x{7};
y14 := x{3} ^ x{5};
y13 := x{0} ^ x{6};
y9 := x{0} ^ x{3};

y8 := x{0} ^ x{5};
t0 := x{1} ^ x{2};
y1 := t0 ^ x{7};

y4 := y1 ^ x{3};
y12 := y13 ^ y14;
y2 := y1 ^ x{0};

y5 := y1 ^ x{6};
y3 := y5 ^ y8;
t1 := x{4} ^ y12;

y15 := t1 ^ x{5};
y20 := t1 ^ x{1};
y6 := y15 ^ x{7};

y10 := y15 ^ t0;
y11 := y20 ^ y9;
y7 := x{7} ^ y11;

y17 := y10 ^ y11;
y19 := y10 ^ y8;
y16 := t0 ^ y11;

y21 := y13 ^ y16;
y18 := x{0} ^ y16;



t2 := y12 & y15;
t3 := y3 & y6;
t4 := t3 ^ t2;

t5 := y4 & x{7};
t6 := t5 ^ t2;
t7 := y13 & y16;

t8 := y5 & y1;
t9 := t8 ^ t7;
t10 := y2 & y7;

t11 := t10 ^ t7;
t12 := y9 & y11;
t13 := y14 & y17;

t14 := t13 ^ t12;
t15 := y8 & y10;
t16 := t15 ^ t12;

t17 := t4 ^ t14;
t18 := t6 ^ t16;
t19 := t9 ^ t14;

t20 := t11 ^ t16;
t21 := t17 ^ y20;
t22 := t18 ^ y19;

t23 := t19 ^ y21;
t24 := t20 ^ y18;

t25 := t21 ^ t22;
t26 := t21 & t23;
t27 := t24 ^ t26;

t28 := t25 & t27;
t29 := t28 ^ t22;
t30 := t23 ^ t24;
t31 := t22 ^ t26;
t32 := t31 & t30;
t33 := t32 ^ t24;
t34 := t23 ^ t33;
t35 := t27 ^ t33;
t36 := t24 & t35;
t37 := t36 ^ t34;
t38 := t27 ^ t36;
t39 := t29 & t38;
t40 := t25 ^ t39;
t41 := t40 ^ t37;
t42 := t29 ^ t33;
t43 := t29 ^ t40;
t44 := t33 ^ t37;
t45 := t42 ^ t41;

z0 := t44 & y15;
z1 := t37 & y6;
z2 := t33 & x{7};
z3 := t43 & y16;
z4 := t40 & y1;
z5 := t29 & y7;
z6 := t42 & y11;
z7 := t45 & y17;
z8 := t41 & y10;
z9 := t44 & y12;
z10 := t37 & y3;
z11 := t33 & y4;
z12 := t43 & y13;
z13 := t40 & y5;
z14 := t29 & y2;
z15 := t42 & y9;
z16 := t45 & y14;
z17 := t41 & y8;

t46 := z15 ^ z16;





t47 := z10 ^ z11;
t48 := z5 ^ z13;
t49 := z9 ^ z10;
t50 := z2 ^ z12;
t51 := z2 ^ z5;
t52 := z7 ^ z8;
t53 := z0 ^ z3;
t54 := z6 ^ z7;
t55 := z16 ^ z17;
t56 := z12 ^ t48;
t57 := t50 ^ t53;
t58 := z4 ^ t46;
t59 := z3 ^ t54;
t60 := t46 ^ t57; 
t61 := z14 ^ t57;
t62 := t52 ^ t58;
t63 := t49 ^ t58;
t64 := z4 ^ t59;
t65 := t61 ^ t62; 
t66 := z1 ^ t63;

s := 0{8};

s{0} := t59 ^ t63;
s{6} := (t56 ^ t62) ^ 1; 
s{7} := (t48 ^ t60) ^ 1;
t67 := t64 ^ t65;
s{3} := t53 ^ t66;
s{4} := t51 ^ t66;
s{5} := t47 ^ t65;
s{1} := (t64 ^ s{3}) ^ 1; 
s{2} := (t55 ^ t67) ^ 1;

s := s{0}.s{1}.s{2}.s{3}.s{4}.s{5}.s{6}.s{7};

$1 := s;')


defvar key := input.0{128};

bits_to_array(key_vec, key);

for i from 0 to 15
begin
    sbox(one_at_a_time1, key_vec[i]);
    sbox2(one_at_a_time2, key_vec[i]);
    one_at_a_time := one_at_a_time1 ^ one_at_a_time2;
    output.0 := one_at_a_time;
    output.1 := one_at_a_time;
end
